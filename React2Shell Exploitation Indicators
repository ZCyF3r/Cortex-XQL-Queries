//Detecting React2shell indicators from "node" or "next" parent processes on tagged web server or internet facing assests

config case_sensitive = false timeframe = 30d

| dataset = xdr_data
| filter event_type = ENUM.NETWORK or event_type = ENUM.PROCESS
| filter (
    (action_local_port in (3000, 8080, 443, 80) or action_remote_port in (3000, 8080, 443, 80))
    and
    (actor_process_image_name contains "node" or actor_process_image_name contains "next")
)
or (
    event_type = ENUM.PROCESS
    and
    (actor_process_image_name contains "node" or actor_process_image_name contains "next")
    and
// Prototype pollution exploitation indicators
    (
        action_process_image_command_line contains "__proto__" or
        action_process_image_command_line contains "constructor:constructor" or
        action_process_image_command_line contains "process.mainModule.require" or
        action_process_image_command_line contains "execSync" or
        action_process_image_command_line contains "vm.runInThisContext" or
        action_process_image_command_line contains "fs.readFileSync" or
// Common exploitation commands
        action_process_image_command_line contains "whoami" or
        action_process_image_command_line contains "/etc/passwd" or
        action_process_image_command_line contains "id" or
        action_process_image_command_line contains "env"
        action_process_image_command_line contains "hostname"
    )
)
| fields _time, event_type, agent_hostname, actor_process_image_name, action_process_image_name, action_process_image_command_line, action_local_ip, action_remote_ip, action_local_port, action_remote_port, actor_effective_username
| sort asc _time
