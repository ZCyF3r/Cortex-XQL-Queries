//
//

config case_sensitive = false timeframe = 7d

| dataset = cloud_audit_logs 
| filter cloud_provider = ENUM.AWS
| filter operation_name_orig in ("GetObject", "ListObjects")
| filter incidr(caller_ip, "10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16, 127.0.0.0/8, 224.0.0.0/4") = false
| filter operation_name_orig = "GetObject"
| filter resource_type_orig = "s3.amazonaws.com"
| filter operation_status = "Success"
| alter S3Bucket = json_extract_scalar(raw_log, "$.requestParameters.bucketName")
| alter BucketFile = json_extract_scalar(raw_log, "$.requestParameters.key")
| fields _time, S3Bucket, BucketFile, operation_name_orig, caller_ip, caller_ip_asn, caller_ip_geolocation, identity_invoked_by_uuid, identity_name, referenced_resource, raw_log, user_agent
