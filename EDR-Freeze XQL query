//EDR-Freeze targeting EDR/AV processes and invoking NtSuspendProcess
//EDR process list Cortex, CS, WinDef, Bitdefender, SentinalOne, Elastic, Huntress, Secureworks, symantec, Sophos


config case_sensitive = false timeframe = 30d
| dataset = xdr_data
| filter actor_process_image_name contains "WerFaultSecure.exe"
  and actor_process_image_name contains "(?i)(CyveraService\.exe|cortex-xdr-payload\.exe|CSFalconService\.exe|CrowdStrikeService\.exe|HuntressAgent\.exe|HuntressUpdater\.exe|SentinelAgent\.exe|SentinelHelperService\.exe|bdservicehost\.exe|vsserv\.exe|ntrtscan\.exe|clientcommunicationservice\.exe|elastic-agent\.exe|elastic-endpoint\.exe|MsMpEng\.exe|Sense\.exe|ccSvcHst\.exe|Smc\.exe)"
| alter wer_time = event_timestamp
| fields agent_hostname, actor_process_image_name, actor_process_command_line, action_process_image_name, wer_time
| join conflict_strategy = left
  (
    dataset = xdr_data
    | filter actor_process_command_line contains "NtSuspendProcess"
    | alter suspend_time = event_timestamp
    | fields agent_hostname, actor_process_image_name as suspender_process, actor_process_command_line as suspender_cmd, suspend_time
  ) as suspend_data
| filter timestamp_diff(suspend_time, wer_time, "second") > 0
| filter timestamp_diff(suspend_time, wer_time, "second") < 300
