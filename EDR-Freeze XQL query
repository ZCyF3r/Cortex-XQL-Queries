//EDR-Freeze detection
//Detects WER processes loading ntdll.dll
//Extracts the target PID from the command line
//Joins with ALL processes to get the target process name
//THEN filters to only show when the target is EDR/AV


config case_sensitive = false timeframe = 30d

| dataset = xdr_data
| filter event_type = ENUM.LOAD_IMAGE
| filter action_process_image_name in ("WerFaultSecure.exe", "WerFault.exe")
| filter action_module_path contains "ntdll.dll"
| alter target_pid_array = regextract(action_process_command_line, "(\d+)")
| alter target_pid = arrayindex(target_pid_array, 0)
| filter target_pid != null
| join (
    dataset = xdr_data
    | alter edr_pid = to_string(action_process_pid)
    | fields edr_pid, action_process_image_name as target_process_name
) as edr_processes edr_processes.edr_pid = target_pid
| filter target_process_name in ("CrowdStrike", "SentinelOne", "MsMpEng", "CarbonBlack", "CSFalcon", "MsSense", "Defender")
| comp count() as edr_targeting by action_local_ip, actor_primary_username, target_process_name
