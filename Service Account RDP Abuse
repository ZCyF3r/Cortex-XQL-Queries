//Service Account RDP Abuse
//This detection detects for service account that begins with SA_ or svc-, performing RDP connections outside of business hours, from external sources
config case_sensitive = false timeframe = 14d
| dataset = xdr_data 
| filter event_type = ENUM.PROCESS 
| filter event_sub_type = ENUM.PROCESS_START and 
        actor_process_image_name in ("winlogon.exe", "mstsc.exe", "userinit.exe", "explorer.exe")
| filter actor_effective_username ~= "^SA_.*" or
        actor_effective_username ~= "^svc-.*"
| alter service_account = actor_effective_username 
| alter host_name = agent_hostname 
| alter SRC_IP = coalesce(action_remote_ip, actor_remote_ip)
| alter logon_time = _time
| alter hour_of_day = format_timestamp("%H", logon_time)
| alter day_of_week = format_timestamp("%u", logon_time)
| alter business_hours = if(
    to_integer(hour_of_day) >= 9 and to_integer(hour_of_day) <= 17 and
    to_integer(day_of_week) <= 5, true, false
)
| filter business_hours = false or
        SRC_IP !~= "^10\.|^172\.(1[6-9]|2[0-9]|3[0-1])\.|^192\.168\."
| comp count() as logon_count, 
      count_distinct(host_name) as unique_hosts,
      count_distinct(SRC_IP) as unique_sources,
      values(host_name) as target_hosts,
      values(SRC_IP) as source_ips,
      min(logon_time) as first_logon,
      max(logon_time) as last_logon
      by service_account 
| alter threat_level = if(
    unique_hosts >= 3 or unique_sources >= 2, "HIGH",
    if(logon_count >= 3, "MEDIUM", "LOW")
)
| alter abuse_pattern = if(
    unique_hosts >= 3, "MULTI_HOST_COMPROMISE",
    if(unique_sources >= 2, "MULTI_SOURCE_ACCESS", "ISOLATED_ABUSE")
)
| fields first_logon, last_logon, service_account, threat_level, abuse_pattern, logon_count, unique_hosts, unique_sources, target_hosts, source_ips
| sort desc threat_level, desc logon_count
