dataset = msft_azure_ad_raw
// === INVOKE-GRAPHRUNNER MODULE DETECTION ===
// Define the specific API endpoints called by Invoke-GraphRunner
| filter (
    requestUri contains "https://graph.microsoft.com/v1.0/search/query" or
    requestUri contains "https://graph.microsoft.com/v1.0/servicePrincipals/" or
    requestUri contains "https://graph.microsoft.com/v1.0/users/" or
    requestUri contains "https://graph.microsoft.com/v1.0/organization" or
    requestUri contains "https://graph.microsoft.com/v1.0/applications" or
    requestUri contains "https://graph.microsoft.com/v1.0/servicePrincipals?$skiptoken=" or
    requestUri contains "https://graph.microsoft.com/v1.0/groups/" or
    requestUri contains "https://graph.microsoft.com/beta/policies/authorizationPolicy"
)
// GraphRunner uses PowerShell User-Agent
| filter userAgent contains "PowerShell"
// === DETECT RAPID SEQUENTIAL API CALLS (GraphRunner pattern) ===
| comp count() as api_call_count,
       count_distinct(requestUri) as unique_endpoints,
       values(requestUri) as endpoints_accessed,
       min(_time) as first_call,
       max(_time) as last_call
       by userPrincipalName, ipAddress
// Calculate time difference between first and last call
| alter time_window_seconds = timestamp_diff(last_call, first_call, "SECOND")
// Detect: Multiple API calls within seconds (automated tool behavior)
| filter api_call_count >= 5 and time_window_seconds <= 60
| fields userPrincipalName,
        ipAddress,
        api_call_count,
        unique_endpoints,
        time_window_seconds,
        endpoints_accessed,
        first_call,
        last_call
| sort desc api_call_count
